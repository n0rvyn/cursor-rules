---
description: "è®¤è¯ä¸å®‰å…¨ - æ£€æŸ¥æ¸…å•"
scopes: [chat, edit]
tags: [authentication, firebase-auth, security, checklist]
priority: 106
globs: ["**/*Auth*.swift", "**/*Login*.swift"]
alwaysApply: false
---

# è®¤è¯æ£€æŸ¥æ¸…å•

> **è§¦å‘æ¡ä»¶**: ç¼–è¾‘è®¤è¯ç›¸å…³æ–‡ä»¶æ—¶è‡ªåŠ¨åŠ è½½  
> **è¯¦ç»†å‚è€ƒ**: `docs/03-decisions/ADR-009-backend-auth-strategy.md`

---

## ğŸ”´ æ ¸å¿ƒçº¦æŸ

### Token éªŒè¯æµç¨‹ â­â­â­â­â­

#### 1. æ‰€æœ‰ Backend è¯·æ±‚å¿…é¡»å¸¦ Firebase ID Token

```swift
// âœ… æ­£ç¡®
func callBackendAPI() async throws {
    guard let token = try await Auth.auth().currentUser?.getIDToken() else {
        throw AuthError.notAuthenticated
    }
    
    var request = URLRequest(url: backendURL)
    request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
    
    let (data, _) = try await URLSession.shared.data(for: request)
    // ...
}

// âŒ é”™è¯¯ï¼šä¸å¸¦ Token
var request = URLRequest(url: backendURL)
let (data, _) = try await URLSession.shared.data(for: request)
```

#### 2. Custom Claims æ£€æŸ¥

```swift
// âœ… æ£€æŸ¥ Premium çŠ¶æ€
guard let user = Auth.auth().currentUser,
      let isPremium = user.customClaims?["premium"] as? Bool,
      isPremium else {
    throw AuthError.notPremium
}
```

#### 3. MVP é˜¶æ®µç®€åŒ–ï¼ˆWeek 1-3ï¼‰

```swift
// âš ï¸ MVP é˜¶æ®µï¼šBackend è·³è¿‡ Token éªŒè¯
// Week 4+ å¯ç”¨å®Œæ•´éªŒè¯
```

---

## ğŸ“‹ æ“ä½œæ­¥éª¤æ¨¡æ¿

### ç”¨æˆ·ç™»å½•

```swift
// Step 1: Firebase ç™»å½•
let authResult = try await Auth.auth().signIn(withEmail: email, password: password)

// Step 2: è·å– ID Token
let token = try await authResult.user.getIDToken()

// Step 3: è·å– Custom Claimsï¼ˆå¦‚æœéœ€è¦ï¼‰
let idTokenResult = try await authResult.user.getIDTokenResult()
let isPremium = idTokenResult.claims["premium"] as? Bool ?? false
```

### Token åˆ·æ–°

```swift
// è‡ªåŠ¨åˆ·æ–°ï¼ˆFirebase SDKï¼‰
let token = try await Auth.auth().currentUser?.getIDToken(forcingRefresh: true)

// å¤±è´¥æ—¶é‡æ–°ç™»å½•
catch {
    // æç¤ºç”¨æˆ·é‡æ–°ç™»å½•
}
```

---

## ğŸ”— è¯¦ç»†å‚è€ƒ

| æ–‡æ¡£ | å†…å®¹ |
|------|------|
| `docs/03-decisions/ADR-009-backend-auth-strategy.md` | â­ å®Œæ•´è®¤è¯ç­–ç•¥ï¼ˆå¿…è¯»ï¼‰ |

---

**æœ€åæ›´æ–°**: 2025-11-08  
**Token ä¼°ç®—**: ~600 tokens  
**åŠ è½½æ–¹å¼**: Auto-attachï¼ˆglobs åŒ¹é…æ—¶ï¼‰  
**ä¼˜å…ˆçº§**: 106

