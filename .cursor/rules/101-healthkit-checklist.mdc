---
description: "HealthKit & WorkoutKit é›†æˆ - æ£€æŸ¥æ¸…å•"
scopes: [chat, edit]
tags: [healthkit, workoutkit, checklist]
priority: 101
globs: ["**/*HealthKit*.swift"]
alwaysApply: false
---

# HealthKit æ£€æŸ¥æ¸…å•

> **è§¦å‘æ¡ä»¶**: ç¼–è¾‘ HealthKit ç›¸å…³æ–‡ä»¶æ—¶è‡ªåŠ¨åŠ è½½  
> **è¯¦ç»†å‚è€ƒ**: `docs/04-implementation/healthkit-integration.md`, `docs/03-decisions/001-healthkit-read-only.md`

---

## âš ï¸ æ“ä½œå‰å¿…é¡»å®Œæˆ

### 1. ç¡®è®¤ Epoch é¡¹ç›®çš„ HealthKit ç­–ç•¥

- [ ] **é“å¾‹**: HealthKit ä¸­çš„è®­ç»ƒè®°å½•æ˜¯å”¯ä¸€çœŸç›¸æº
- [ ] **å…è®¸**: è¯»å–ç”¨æˆ·çš„å†å²è®­ç»ƒæ•°æ®
- [ ] **å…è®¸**: ä½¿ç”¨ WorkoutKit å†™å…¥æœªæ¥çš„è®­ç»ƒè®¡åˆ’ï¼ˆV1.1ï¼‰
- [ ] **ç¦æ­¢**: ä¿®æ”¹æˆ–åˆ é™¤ HealthKit ä¸­å·²å®Œæˆçš„è®­ç»ƒè®°å½•
- [ ] **ç¦æ­¢**: åœ¨ Firebase ä¸­å®Œæ•´å¤åˆ¶ HealthKit æ•°æ®ï¼Œåªå­˜ `healthKitWorkoutId`

### 2. è¯»å–å…³é”®æ–‡æ¡£

- [ ] `docs/03-decisions/001-healthkit-read-only.md`ï¼ˆç­–ç•¥å†³ç­–ï¼‰
- [ ] `docs/04-implementation/healthkit-integration.md`ï¼ˆå®ç°ç»†èŠ‚ï¼‰

---

## ğŸ”´ æ ¸å¿ƒçº¦æŸ

### HealthKit æ•°æ®ç­–ç•¥ â­â­â­â­â­

#### 1. æ°¸ä¸ä¿®æ”¹å·²å®Œæˆçš„è®­ç»ƒè®°å½•

```swift
âŒ æ°¸ä¸è°ƒç”¨ï¼š
- HKHealthStore.delete()
- HKWorkout çš„ä»»ä½•ä¿®æ”¹æ“ä½œ

âœ… åªå…è®¸ï¼š
- HKHealthStore.execute(query)ï¼ˆè¯»å–ï¼‰
- WorkoutKit å†™å…¥æœªæ¥è®¡åˆ’ï¼ˆV1.1ï¼‰
```

#### 2. ä¸åœ¨ Firebase ä¸­å®Œæ•´å¤åˆ¶ HealthKit æ•°æ®

```swift
âŒ é”™è¯¯ï¼š
struct TrainingLogDTO {
    let healthKitWorkoutId: String
    let distance: Double  // âŒ å¤åˆ¶äº† HealthKit æ•°æ®
    let duration: TimeInterval  // âŒ å¤åˆ¶äº† HealthKit æ•°æ®
    let heartRate: Double  // âŒ å¤åˆ¶äº† HealthKit æ•°æ®
}

âœ… æ­£ç¡®ï¼š
struct TrainingLogDTO {
    let healthKitWorkoutId: String  // â­ åªå­˜ ID
    let userNotes: String?  // âœ… ç”¨æˆ·æ·»åŠ çš„æ•°æ®
    let rpe: Int?  // âœ… ç”¨æˆ·æ·»åŠ çš„æ•°æ®ï¼ˆå¯é€‰ï¼‰
}
```

**åŸå› **ï¼š
- HealthKit æ˜¯å”¯ä¸€çœŸç›¸æº
- é¿å…æ•°æ®ä¸ä¸€è‡´
- éµå®ˆ Apple éšç§æ”¿ç­–

#### 3. WorkoutKit æ”¯æŒï¼ˆV1.1 åŠŸèƒ½ï¼‰

```markdown
âš ï¸ **MVP é˜¶æ®µ**ï¼šæš‚ä¸å®ç° WorkoutKit åŠŸèƒ½
ğŸ“… **V1.1**ï¼šå®ç°è®­ç»ƒè®¡åˆ’åŒæ­¥åˆ° Apple Watch
```

---

## ğŸ“Š HealthKit é›†æˆæ¨¡å¼

### Authorization Management

#### 1. Request Authorization Once

**Up-front authorization** or just-in-time on user-initiated paths:
```swift
// âœ… åœ¨ Onboarding æˆ–ç”¨æˆ·ä¸»åŠ¨è¯·æ±‚æ—¶
func requestHealthKitAuthorization() async throws {
    guard HKHealthStore.isHealthDataAvailable() else {
        throw HealthKitError.notAvailable
    }
    
    let typesToRead: Set<HKObjectType> = [
        HKObjectType.workoutType(),
        HKObjectType.quantityType(forIdentifier: .distanceWalkingRunning)!,
        HKObjectType.quantityType(forIdentifier: .heartRate)!,
        // ... å…¶ä»–ç±»å‹
    ]
    
    try await healthStore.requestAuthorization(toShare: [], read: typesToRead)
}

// âŒ åœ¨çƒ­è·¯å¾„/åå°æŸ¥è¯¢ä¸­è¯·æ±‚æˆæƒ
```

#### 2. Include All Required Types (Epoch ä¸“ç”¨)

```swift
let typesToRead: Set<HKObjectType> = [
    // è®­ç»ƒæ•°æ®ï¼ˆæ ¸å¿ƒï¼‰
    HKObjectType.workoutType(),
    HKObjectType.quantityType(forIdentifier: .distanceWalkingRunning)!,
    HKObjectType.quantityType(forIdentifier: .activeEnergyBurned)!,
    
    // å¿ƒç‡æ•°æ®
    HKObjectType.quantityType(forIdentifier: .heartRate)!,
    HKObjectType.quantityType(forIdentifier: .restingHeartRate)!,
    HKObjectType.quantityType(forIdentifier: .heartRateVariabilitySDNN)!,
    
    // iOS 18+ æ–°å¢å­—æ®µ
    HKObjectType.quantityType(forIdentifier: .workoutEffortScore),  // RPE
    HKObjectType.quantityType(forIdentifier: .heartRateRecoveryOneMinute)
]
```

### Query Patterns

#### 1. ä½¿ç”¨ç°ä»£ Query APIï¼ˆiOS 18+ï¼‰

```swift
// âœ… iOS 18+ HKSampleQueryDescriptorï¼ˆæ¨èï¼‰
func fetchRecentWorkouts(limit: Int = 20) async throws -> [HKWorkout] {
    let descriptor = HKSampleQueryDescriptor(
        sampleType: HKObjectType.workoutType(),
        predicate: HKQuery.predicateForWorkouts(with: .running),  // åªæŸ¥è¯¢è·‘æ­¥
        sortDescriptors: [
            NSSortDescriptor(
                key: HKSampleSortIdentifierStartDate,
                ascending: false
            )
        ],
        limit: limit
    )
    
    let results = try await descriptor.result(for: healthStore)
    return results as? [HKWorkout] ?? []
}
```

#### 2. Epoch å¢é‡åŒæ­¥ç­–ç•¥

```swift
// âœ… åªæŸ¥è¯¢å¢é‡æ•°æ®
func fetchIncrementalWorkouts(since date: Date) async throws -> [HKWorkout] {
    let predicate = NSCompoundPredicate(andPredicateWithSubpredicates: [
        HKQuery.predicateForWorkouts(with: .running),
        HKQuery.predicateForSamples(
            withStart: date,
            end: nil,
            options: .strictStartDate
        )
    ])
    
    let descriptor = HKSampleQueryDescriptor(
        sampleType: HKObjectType.workoutType(),
        predicate: predicate,
        sortDescriptors: [
            NSSortDescriptor(
                key: HKSampleSortIdentifierStartDate,
                ascending: false
            )
        ]
    )
    
    let results = try await descriptor.result(for: healthStore)
    return results as? [HKWorkout] ?? []
}
```

#### 3. æ€§èƒ½è¦æ±‚

**Epoch é¡¹ç›®è¦æ±‚**ï¼š
- **HealthKit æŸ¥è¯¢**: <100msï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
- **åå°åŒæ­¥**: ä¸é˜»å¡ UI
- **å¢é‡åŒæ­¥**: åªæŸ¥è¯¢å¢é‡æ•°æ®ï¼Œä¸å…¨é‡æŸ¥è¯¢

---

## âŒ å¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šå…¨é‡æŸ¥è¯¢ HealthKit æ•°æ®

```swift
// âŒ é”™è¯¯ï¼šæ¯æ¬¡éƒ½æŸ¥è¯¢æ‰€æœ‰æ•°æ®
func fetchAllWorkouts() async throws -> [HKWorkout] {
    let descriptor = HKSampleQueryDescriptor(
        sampleType: HKObjectType.workoutType(),
        predicate: nil,  // âŒ æŸ¥è¯¢æ‰€æœ‰
        sortDescriptors: []
    )
    // ...
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¢é‡åŒæ­¥
func syncWorkouts() async throws {
    let lastSyncDate = UserDefaults.standard.object(forKey: "lastSyncDate") as? Date ?? Date.distantPast
    let newWorkouts = try await fetchIncrementalWorkouts(since: lastSyncDate)
    // åªå¤„ç†æ–°æ•°æ®
    UserDefaults.standard.set(Date(), forKey: "lastSyncDate")
}
```

### é”™è¯¯ 2ï¼šåœ¨ Firebase ä¸­å¤åˆ¶ HealthKit æ•°æ®

```swift
// âŒ é”™è¯¯ï¼šå®Œæ•´å¤åˆ¶
struct TrainingLogDTO {
    let healthKitWorkoutId: String
    let distance: Double  // âŒ
    let duration: TimeInterval  // âŒ
}

// âœ… æ­£ç¡®ï¼šåªå­˜ç”¨æˆ·æ·»åŠ çš„æ•°æ®
struct TrainingLogDTO {
    let healthKitWorkoutId: String  // â­ åªå­˜ ID
    let userNotes: String?  // âœ… ç”¨æˆ·æ·»åŠ 
    let rpe: Int?  // âœ… ç”¨æˆ·æ·»åŠ 
}
```

### é”™è¯¯ 3ï¼šä¿®æ”¹ HealthKit è®°å½•

```swift
// âŒ æ°¸ä¸å…è®¸
try await healthStore.delete(workout)
```

---

## ğŸ“‹ æ“ä½œæ­¥éª¤æ¨¡æ¿

### é¦–æ¬¡æˆæƒ

```swift
// Step 1: æ£€æŸ¥å¯ç”¨æ€§
guard HKHealthStore.isHealthDataAvailable() else {
    throw HealthKitError.notAvailable
}

// Step 2: æ£€æŸ¥æˆæƒçŠ¶æ€
let authStatus = healthStore.authorizationStatus(for: HKObjectType.workoutType())
guard authStatus != .sharingAuthorized else {
    return  // å·²æˆæƒ
}

// Step 3: è¯·æ±‚æˆæƒ
try await requestHealthKitAuthorization()
```

### å¢é‡åŒæ­¥

```swift
// Step 1: è·å–ä¸Šæ¬¡åŒæ­¥æ—¶é—´
let lastSyncDate = UserDefaults.standard.object(forKey: "lastSyncDate") as? Date ?? Date.distantPast

// Step 2: æŸ¥è¯¢å¢é‡æ•°æ®
let newWorkouts = try await fetchIncrementalWorkouts(since: lastSyncDate)

// Step 3: å¤„ç†æ–°æ•°æ®
for workout in newWorkouts {
    try await processWorkout(workout)
}

// Step 4: æ›´æ–°åŒæ­¥æ—¶é—´
UserDefaults.standard.set(Date(), forKey: "lastSyncDate")
```

### ç¼“å­˜é¢‘ç¹è®¿é—®çš„æ•°æ®

```swift
// âœ… ä½¿ç”¨ SwiftData ç¼“å­˜æœ€è¿‘ 14 å¤©
actor HealthKitCacheService {
    func getCachedWorkouts(limit: Int = 14) throws -> [CachedTrainingLog] {
        let descriptor = FetchDescriptor<CachedTrainingLog>(
            predicate: #Predicate { log in
                log.date > Date().addingTimeInterval(-14 * 24 * 3600)
            },
            sortBy: [SortDescriptor(\.date, order: .reverse)]
        )
        return try modelContext.fetch(descriptor)
    }
}
```

---

## ğŸ”— è¯¦ç»†å‚è€ƒ

| æ–‡æ¡£ | å†…å®¹ |
|------|------|
| `docs/03-decisions/001-healthkit-read-only.md` | â­ HealthKit ç­–ç•¥å†³ç­–ï¼ˆå¿…è¯»ï¼‰ |
| `docs/04-implementation/healthkit-integration.md` | å®Œæ•´å®ç°ç»†èŠ‚ |
| `203-healthkit-integration-detailed.mdc` | è¯¦ç»†å‚è€ƒ |

---

**æœ€åæ›´æ–°**: 2025-11-08  
**Token ä¼°ç®—**: ~1,300 tokens  
**åŠ è½½æ–¹å¼**: Auto-attachï¼ˆglobs åŒ¹é…æ—¶ï¼‰  
**ä¼˜å…ˆçº§**: 101

