---
description: "SwiftData æ•°æ®æ¨¡å‹ - æ£€æŸ¥æ¸…å•"
scopes: [chat, edit]
tags: [swiftdata, data-model, dto, mapper, checklist]
priority: 105
globs: ["**/*Model*.swift", "**/Cached*.swift"]
alwaysApply: false
---

# SwiftData æ•°æ®æ¨¡å‹æ£€æŸ¥æ¸…å•

> **è§¦å‘æ¡ä»¶**: ç¼–è¾‘æ•°æ®æ¨¡å‹æ–‡ä»¶æ—¶è‡ªåŠ¨åŠ è½½  
> **è¯¦ç»†å‚è€ƒ**: `docs/04-implementation/swiftdata-schema.md`

---

## ğŸ”´ æ ¸å¿ƒçº¦æŸ

### åŒ Model æ¶æ„ï¼ˆå¼ºåˆ¶ï¼‰â­â­â­â­â­

```
Firebase DTO (struct, Codable) â†” Mapper â†” SwiftData Model (class, @Model)
```

#### å‘½åè§„èŒƒ

```swift
// âœ… SwiftData Model: Cached{Entity}
@Model
class CachedTrainingLog {
    var id: String
    var userId: String
    var date: Date
    // ...
}

// âœ… Firebase DTO: {Entity}DTO
struct TrainingLogDTO: Codable {
    let id: String
    let userId: String
    let date: Date
    // ...
}

// âœ… Mapper: {Entity}Mapper
struct TrainingLogMapper {
    static func toSwiftData(_ dto: TrainingLogDTO) -> CachedTrainingLog {
        // ...
    }
    
    static func toDTO(_ model: CachedTrainingLog) -> TrainingLogDTO {
        // ...
    }
}
```

### å…³é”®è§„åˆ™

#### 1. å…³ç³»è®¾è®¡å¿…é¡»æŒ‡å®š deleteRule

```swift
@Model
class CachedTrainingPlan {
    @Relationship(deleteRule: .cascade)
    var weeks: [CachedWeekPlan]
}
```

#### 2. æ‰€æœ‰ Model å¿…é¡»æ”¯æŒè½¯åˆ é™¤

```swift
@Model
class CachedTrainingLog {
    var deletedAt: Date?  // â­ è½¯åˆ é™¤
}

// æŸ¥è¯¢æ—¶è¿‡æ»¤å·²åˆ é™¤
let descriptor = FetchDescriptor<CachedTrainingLog>(
    predicate: #Predicate { $0.deletedAt == nil }
)
```

#### 3. æ—¶é—´æˆ³å­—æ®µï¼ˆç”¨äºåŒæ­¥ï¼‰

```swift
@Model
class CachedTrainingLog {
    var lastModifiedMs: Double  // â­ æ¯«ç§’çº§æ—¶é—´æˆ³
    var lastSyncedMs: Double?   // ä¸Šæ¬¡åŒæ­¥æ—¶é—´
    var createdAt: Date
    var updatedAt: Date
}
```

---

## ğŸ“‹ æ“ä½œæ­¥éª¤æ¨¡æ¿

### åˆ›å»ºæ–°çš„æ•°æ®æ¨¡å‹

```swift
// Step 1: å®šä¹‰ Firebase DTO
struct TrainingLogDTO: Codable {
    let id: String
    let userId: String
    let healthKitWorkoutId: String
    let date: Date
    let userNotes: String?
    let rpe: Int?
    let lastModifiedMs: Double
}

// Step 2: å®šä¹‰ SwiftData Model
@Model
class CachedTrainingLog {
    @Attribute(.unique) var id: String
    var userId: String
    var healthKitWorkoutId: String
    var date: Date
    var userNotes: String?
    var rpe: Int?
    var lastModifiedMs: Double
    var lastSyncedMs: Double?
    var deletedAt: Date?
    
    init(id: String, userId: String, ...) {
        self.id = id
        self.userId = userId
        // ...
        self.lastModifiedMs = Date().timeIntervalSince1970 * 1000
    }
}

// Step 3: å®šä¹‰ Mapper
struct TrainingLogMapper {
    static func toSwiftData(_ dto: TrainingLogDTO) -> CachedTrainingLog {
        CachedTrainingLog(
            id: dto.id,
            userId: dto.userId,
            // ... æ˜ å°„æ‰€æœ‰å­—æ®µ
        )
    }
    
    static func toDTO(_ model: CachedTrainingLog) -> TrainingLogDTO {
        TrainingLogDTO(
            id: model.id,
            userId: model.userId,
            // ... æ˜ å°„æ‰€æœ‰å­—æ®µ
        )
    }
}
```

---

## ğŸ”— è¯¦ç»†å‚è€ƒ

| æ–‡æ¡£ | å†…å®¹ |
|------|------|
| `docs/04-implementation/swiftdata-schema.md` | â­ å®Œæ•´æ•°æ®æ¨¡å‹æ¶æ„ï¼ˆå¿…è¯»ï¼‰ |

---

**æœ€åæ›´æ–°**: 2025-11-08  
**Token ä¼°ç®—**: ~800 tokens  
**åŠ è½½æ–¹å¼**: Auto-attachï¼ˆglobs åŒ¹é…æ—¶ï¼‰  
**ä¼˜å…ˆçº§**: 105

