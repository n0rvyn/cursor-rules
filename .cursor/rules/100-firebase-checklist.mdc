---
description: "Firebase æ•°æ®ç»“æ„ä¸å®‰å…¨è§„åˆ™ - æ£€æŸ¥æ¸…å•"
scopes: [chat, edit]
tags: [firebase, firestore, security-rules, checklist]
priority: 100
globs: ["**/*Firebase*.swift", "**/*Firestore*.swift"]
alwaysApply: false
---

# Firebase æ£€æŸ¥æ¸…å•

> **è§¦å‘æ¡ä»¶**: ç¼–è¾‘ Firebase/Firestore ç›¸å…³æ–‡ä»¶æ—¶è‡ªåŠ¨åŠ è½½  
> **è¯¦ç»†å‚è€ƒ**: `docs/04-implementation/firebase-schema.md`

---

## âš ï¸ æ“ä½œå‰å¿…é¡»å®Œæˆ

### 1. è¯»å– Firebase Schema æ–‡æ¡£

- [ ] **å¿…è¯»**: `docs/04-implementation/firebase-schema.md`
  - ç¡®è®¤æ•°æ®è¡¨ç»“æ„
  - ç¡®è®¤å­—æ®µå®šä¹‰
  - ç¡®è®¤æ–‡æ¡£ ID ç”Ÿæˆè§„åˆ™

### 2. éªŒè¯è·¯å¾„æ ¼å¼

- [ ] è·¯å¾„æ®µæ•°ä¸ºå¶æ•°ï¼ˆcollection/documentï¼‰
- [ ] ä½¿ç”¨æ–‡æ¡£å®šä¹‰çš„è·¯å¾„ï¼ˆä¸éšæ„å‘æ˜ï¼‰
- [ ] é¿å…å¥‡æ•°æ®µè·¯å¾„ï¼ˆå¦‚ `users/{userId}/trainingPlans/framework`ï¼‰

### 3. æ£€æŸ¥ Security Rules

- [ ] æ‰“å¼€ `backend/firestore.rules`
- [ ] ç¡®è®¤å¯¹åº” collection æœ‰ match è§„åˆ™
- [ ] ç¡®è®¤ä½¿ç”¨ `isOwner(userId)` æ ¡éªŒ

### 4. ç¡®è®¤ DTO å­—æ®µå®Œæ•´

- [ ] åŒ…å« `userId` å­—æ®µï¼ˆç”¨äº Security Rulesï¼‰
- [ ] åŒ…å« `id` å­—æ®µï¼ˆæ–‡æ¡£ä¸»é”®ï¼‰
- [ ] æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å·²å®šä¹‰

### 5. ä½¿ç”¨æ ‡å‡† FirebaseService æ–¹æ³•

- [ ] ä¼˜å…ˆä½¿ç”¨ `saveTrainingPlan()` ç­‰ä¸“ç”¨æ–¹æ³•
- [ ] é¿å…ç›´æ¥è°ƒç”¨ `saveData(path:data:)`ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰
- [ ] ä½¿ç”¨ Mapper è½¬æ¢ï¼ˆDTO â†” Dictionaryï¼‰

---

## ğŸ”´ æ ¸å¿ƒçº¦æŸ

### Firestore è·¯å¾„è§„åˆ™ï¼ˆå¼ºåˆ¶ï¼‰â­â­â­â­â­

#### 1. è·¯å¾„æ ¼å¼ï¼šcollection/document/collection/document

```markdown
âœ… æ­£ç¡®ï¼štrainingPlans/{planId}ï¼ˆ2æ®µï¼‰
âœ… æ­£ç¡®ï¼šusers/{userId}/settings/profileï¼ˆ4æ®µï¼‰
âŒ é”™è¯¯ï¼šusers/{userId}/trainingPlans/frameworkï¼ˆ3æ®µ - å¥‡æ•°ï¼‰
```

#### 2. æ‰å¹³ç»“æ„ä¼˜å…ˆï¼ˆæ€§èƒ½è€ƒè™‘ï¼‰

| è¡¨å | è·¯å¾„ | æŸ¥è¯¢æ–¹å¼ |
|---|---|---|
| trainingPlans | trainingPlans/{planId} | where('userId', '==', uid) |
| trainingGoals | trainingGoals/{goalId} | where('userId', '==', uid) |
| trainingLogs | trainingLogs/{logId} | where('userId', '==', uid) |

#### 3. åµŒå¥—ç»“æ„ä»…ç”¨äº"1å¯¹1å¼ºä¾èµ–"

```markdown
âœ… users/{userId}/settings/profileï¼ˆè®¾ç½®å±äºç”¨æˆ·ï¼‰
âŒ users/{userId}/trainingPlans/{planId}ï¼ˆè®¡åˆ’å¯ç‹¬ç«‹æŸ¥è¯¢ï¼‰
```

#### 4. æ‰€æœ‰æ–‡æ¡£å¿…é¡»åŒ…å« userId å­—æ®µ

**åŸå› **ï¼š
- ç”¨äº Security Rules æ ¡éªŒ
- ç”¨äº GDPR åˆ é™¤æŸ¥è¯¢
- ç”¨äºå¤šè®¾å¤‡åŒæ­¥è¿‡æ»¤

#### 5. Security Rules æ£€æŸ¥æ¸…å•

- [ ] æ¯ä¸ª collection éƒ½æœ‰å¯¹åº”çš„ match è§„åˆ™
- [ ] ä½¿ç”¨ `isOwner(userId)` æ£€æŸ¥æ‰€æœ‰æƒ
- [ ] create æ—¶æ ¡éªŒ `request.resource.data.userId`
- [ ] read/write æ—¶æ ¡éªŒ `resource.data.userId`

#### 6. firebase-schema.md æ˜¯æƒå¨å®šä¹‰

**ä¼˜å…ˆçº§**ï¼š
```
firebase-schema.md > ä»£ç å®ç°
```

**è§„åˆ™**ï¼š
- å¦‚æœä»£ç ä¸æ–‡æ¡£å†²çªï¼Œä»¥æ–‡æ¡£ä¸ºå‡†
- ä¿®æ”¹æ•°æ®ç»“æ„å¿…é¡»å…ˆæ›´æ–° firebase-schema.md

---

## âŒ å¸¸è§é”™è¯¯ï¼ˆWeek 6 æ•™è®­ï¼‰

### é”™è¯¯ 1ï¼šéšæ„å‘æ˜è·¯å¾„ï¼ˆæœªæŸ¥é˜… firebase-schema.mdï¼‰

**é”™è¯¯ç¤ºä¾‹**ï¼š
```swift
let path = "users/\(userId)/trainingPlans/framework"
```

**é—®é¢˜**ï¼š
- å¥‡æ•°æ®µè·¯å¾„æ— æ•ˆ
- æœªå®šä¹‰åœ¨ schema ä¸­

**æ­£ç¡®åšæ³•**ï¼š
```swift
// æŸ¥é˜… firebase-schema.mdï¼Œä½¿ç”¨æ ‡å‡†è·¯å¾„
firebaseService.saveTrainingPlan(dto) // â†’ trainingPlans/{planId}
```

### é”™è¯¯ 2ï¼šå¿˜è®°æ·»åŠ  Security Rules

**ç»“æœ**ï¼š
```
Error: Permission denied
```

**æ­£ç¡®åšæ³•**ï¼š
1. åœ¨ `backend/firestore.rules` ä¸­æ·»åŠ è§„åˆ™
2. ä½¿ç”¨ `isOwner(userId)` æ ¡éªŒ
3. éƒ¨ç½²è§„åˆ™åæµ‹è¯•

### é”™è¯¯ 3ï¼šä½¿ç”¨åµŒå¥—ç»“æ„ï¼ˆåº”è¯¥ç”¨æ‰å¹³ + where æŸ¥è¯¢ï¼‰

**é—®é¢˜**ï¼š
- æŸ¥è¯¢æ€§èƒ½å·®
- GDPR åˆ é™¤å¤æ‚

**æ­£ç¡®åšæ³•**ï¼š
```swift
// âŒ åµŒå¥—ï¼šusers/{userId}/trainingPlans/{planId}
// âœ… æ‰å¹³ï¼štrainingPlans/{planId}
//    æŸ¥è¯¢ï¼šwhere("userId", isEqualTo: userId)
```

### é”™è¯¯ 4ï¼šæ–‡æ¡£ç¼ºå°‘ userId å­—æ®µ

**ç»“æœ**ï¼š
- Security Rules å¤±æ•ˆ
- æ•°æ®æ³„éœ²é£é™©

**æ­£ç¡®åšæ³•**ï¼š
```swift
struct TrainingPlanDTO: Codable {
    let id: String
    let userId: String  // â­ å¿…é¡»
    // ... å…¶ä»–å­—æ®µ
}
```

---

## ğŸ“‹ æ“ä½œæ­¥éª¤æ¨¡æ¿

### ä¿å­˜æ•°æ®åˆ° Firebase

```swift
// Step 1: è¯»å– firebase-schema.mdï¼Œç¡®è®¤è·¯å¾„
// ä¾‹å¦‚ï¼štrainingPlans/{planId}

// Step 2: åˆ›å»º DTO
let dto = TrainingPlanDTO(
    id: UUID().uuidString,
    userId: userId,  // â­ å¿…é¡»
    // ... å…¶ä»–å­—æ®µ
)

// Step 3: ä½¿ç”¨ FirebaseService ä¿å­˜
try await firebaseService.saveTrainingPlan(dto)

// Step 4: éªŒè¯ Security Rules
// æ‰“å¼€ backend/firestore.rulesï¼Œç¡®è®¤æœ‰å¯¹åº”è§„åˆ™
```

### æŸ¥è¯¢æ•°æ®

```swift
// Step 1: è¯»å– firebase-schema.mdï¼Œç¡®è®¤è·¯å¾„å’ŒæŸ¥è¯¢æ–¹å¼

// Step 2: ä½¿ç”¨ where æŸ¥è¯¢ï¼ˆæ‰å¹³ç»“æ„ï¼‰
let plans = try await firebaseService.fetchTrainingPlans(userId: userId)

// å†…éƒ¨å®ç°ï¼š
// db.collection("trainingPlans")
//   .whereField("userId", isEqualTo: userId)
//   .getDocuments()
```

### GDPR åˆ é™¤

```swift
// Step 1: åˆ é™¤æ‰€æœ‰åŒ…å« userId çš„æ–‡æ¡£

// æ‰å¹³ç»“æ„å¾ˆç®€å•ï¼š
let collections = ["trainingPlans", "trainingGoals", "trainingLogs"]
for collection in collections {
    let docs = db.collection(collection)
        .whereField("userId", isEqualTo: userId)
        .getDocuments()
    for doc in docs.documents {
        try await doc.reference.delete()
    }
}

// å¦‚æœä½¿ç”¨åµŒå¥—ç»“æ„ï¼Œéœ€è¦é€’å½’åˆ é™¤ï¼ˆå¾ˆéº»çƒ¦ï¼‰
```

---

## ğŸ”— è¯¦ç»†å‚è€ƒ

| æ–‡æ¡£ | å†…å®¹ |
|------|------|
| `docs/04-implementation/firebase-schema.md` | â­ å®Œæ•´æ•°æ®ç»“æ„å®šä¹‰ï¼ˆæƒå¨ï¼‰ |
| `backend/firestore.rules` | Security Rules æ–‡ä»¶ |
| `200-project-overview-detailed.mdc` | Â§ 5.5 Firebase æ•°æ®ç»“æ„ç´¢å¼• |

---

**æœ€åæ›´æ–°**: 2025-11-08  
**Token ä¼°ç®—**: ~1,300 tokens  
**åŠ è½½æ–¹å¼**: Auto-attachï¼ˆglobs åŒ¹é…æ—¶ï¼‰  
**ä¼˜å…ˆçº§**: 100

