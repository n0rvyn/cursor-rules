---
description: "è´¨é‡ä¿è¯ - é˜²å¹»è§‰ä¸è¡Œä¸ºä¿æŠ¤ - è¯¦ç»†å‚è€ƒ"
scopes: [chat, edit]
tags: [quality-assurance, anti-hallucination, behavior-preservation, safety, detailed-reference]
priority: 205
globs: []
alwaysApply: false
---

# è´¨é‡ä¿è¯ - é˜²å¹»è§‰ä¸è¡Œä¸ºä¿æŠ¤ï¼ˆè¯¦ç»†å‚è€ƒï¼‰

> **æ³¨æ„**ï¼šæœ¬æ–‡ä»¶ä¸ºè¯¦ç»†å‚è€ƒï¼Œä¸ä¼šè‡ªåŠ¨åŠ è½½ã€‚  
> **è¾¨è¯æ€è€ƒé“å¾‹**ï¼šè§ `000-critical-rules.mdc` çš„"AI å·¥ä½œåŸåˆ™"éƒ¨åˆ†

---

> **æ ¸å¿ƒåŸåˆ™**: ä¿æŠ¤ç°æœ‰åŠŸèƒ½ï¼Œé˜²æ­¢å›å½’ï¼›éªŒè¯æ‰€æœ‰ä¿¡æ¯ï¼Œé˜²æ­¢å¹»è§‰

---

## ğŸ›¡ï¸ Anti-Hallucination Measures

### Core Principles

```markdown
1. **Verify Information**: Always cross-check against provided context before coding
2. **File-by-File Changes**: Complete one file before moving to next, ask for review
3. **Single Chunk Edits**: Provide all file edits in one block to avoid fragmentation
4. **Explicit Confirmation**: Ask before major architectural changes
5. **Reference Existing Patterns**: Check existing code before creating new approaches
```

### Quality Gates

```markdown
âœ… **Limit Change Size**: Single modification â‰¤ 120 effective lines
âœ… **Type Check First**: Ensure compilation passes before suggesting
âœ… **Test-Driven Approach**: Write failing tests first, then implement
âœ… **Grep Before Create**: Search existing codebase before introducing new APIs
```

### Self-Validation Process

```markdown
1. **Chain-of-Thought**: For complex problems, reason through step-by-step first
2. **Context Verification**: Re-read requirements before final code generation
3. **Risk Assessment**: End responses with `SELF-CHECK:` noting potential issues
```

**Example of Self-Check:**
```markdown
SELF-CHECK:
âœ… Verified pattern exists in HealthKitService.swift:45-67
âœ… Complexity: 2/10 (simple, reusing existing pattern)
âš ï¸ Potential Issue: Need to handle iOS 18 compatibility
âœ… Mitigation: Added #available check
```

---

## ğŸš¨ Immediate Stop Conditions

**Stop and ask for clarification when:**

- âŒ Context seems contradictory or incomplete
- âŒ Multiple valid interpretations of requirements exist
- âŒ Proposed changes would break existing functionality
- âŒ Dependencies or configurations are assumed but not confirmed
- âŒ No existing pattern found for the requested feature
- âŒ Complexity rating >6/10 without explicit approval

**Example:**
```markdown
â›” STOP: Unclear Requirement

User requested: "Add caching to workout fetching"

CLARIFICATION NEEDED:
1. What should be cached? (Raw HKWorkout data? Converted TrainingLog?)
2. Cache duration? (Session? 24h? 7 days?)
3. Cache invalidation? (Manual? Time-based? Event-based?)
4. Existing pattern? (Check if other services use caching)

BEFORE PROCEEDING:
- Please clarify the caching requirements
- Or point me to existing caching pattern in the codebase
```

---

## ğŸ”’ Behaviour-Preservation Rules

### No Regressions

```markdown
âœ… **New features or bug-fixes MUST NOT break public APIs or observable behaviour**
âœ… **All existing tests must continue to pass**
âœ… **No changes to function signatures without explicit approval**
âœ… **No removal of existing functionality without documentation**
```

### Minimal Patch

```markdown
âœ… **Touch only the lines strictly required**
âœ… **Large rewrites are PROHIBITED unless explicitly requested**
âœ… **Prefer wrapper functions or targeted refactors**
âœ… **No whitespace-only changes**
âœ… **No cosmetic renames unless they fix bugs or improve clarity significantly**
```

**Example of Minimal Patch:**

```swift
// âŒ BAD: Rewriting entire function
func fetchWorkouts() async throws -> [HKWorkout] {
    // Completely rewritten implementation
    // Changes 50 lines when only 2 lines needed fixing
}

// âœ… GOOD: Minimal change
func fetchWorkouts() async throws -> [HKWorkout] {
    // Existing code unchanged...
    
    // Only fix the specific issue
    let descriptor = HKSampleQueryDescriptor(  // Changed line 1
        sampleType: HKObjectType.workoutType(),  // Changed line 2
        predicate: predicate,
        sortDescriptors: sortDescriptors
    )
    
    // Existing code unchanged...
}
```

### Comment Every Deletion

```markdown
âœ… **Every deleted line/function MUST have a comment explaining why**
âœ… **Format**: `// Removed: [reason]`
âœ… **Include reference**: Link to issue/ADR if applicable
```

**Example:**
```swift
// Removed: Old HealthKit query pattern (pre-iOS 18)
// Replaced with HKSampleQueryDescriptor (iOS 18+ only)
// See: docs/03-decisions/ADR-XXX-healthkit-modernization.md
// Old code:
// let query = HKSampleQuery(...)
```

### When Unsure, Ask

```markdown
âš ï¸ **When unsure about impact, ask the user to run tests first**
âš ï¸ **When changing critical paths, explicitly state potential risks**
âš ï¸ **When refactoring, provide "before/after" comparison**
```

---

## ğŸ¯ Quality Checklist

### Before Making Changes

- [ ] **Context Verified**: Re-read user requirements and existing code
- [ ] **Existing Pattern Found**: Located 2-3 similar implementations
- [ ] **Complexity Assessed**: Rated solution 1-10
- [ ] **Impact Analyzed**: Identified affected files and functions
- [ ] **Tests Identified**: Know which tests need to pass

### During Implementation

- [ ] **File-by-File**: Complete one file before moving to next
- [ ] **Single Chunk**: All changes for a file in one edit block
- [ ] **Minimal Diff**: Only change necessary lines
- [ ] **Comments Added**: Explain why, not just what
- [ ] **Deletions Justified**: Every deletion has a reason comment

### After Implementation

- [ ] **Self-Check**: Reviewed changes for potential issues
- [ ] **Compilation**: Code should compile without errors
- [ ] **Tests**: Existing tests should pass
- [ ] **Documentation**: Updated relevant docs (file-structure.md, changelog)
- [ ] **Risk Assessment**: Noted any potential issues

---

## ğŸ“‹ Change Size Guidelines

### Small Change (âœ… Preferred)

```markdown
- â‰¤ 5 files touched
- â‰¤ 50 lines changed per file
- â‰¤ 120 lines total effective change
- Single logical change
- Easy to review and test
```

### Medium Change (âš ï¸ Requires Justification)

```markdown
- 6-10 files touched
- 51-150 lines changed per file
- 121-500 lines total
- Multiple related changes
- Requires careful review
```

### Large Change (âŒ Requires Explicit Approval)

```markdown
- >10 files touched
- >150 lines per file
- >500 lines total
- Architectural changes
- Must ask user before proceeding
```

**Example:**
```markdown
CHANGE SIZE ASSESSMENT:
- Files affected: 3 (HealthKitService.swift, TrainingLogViewModel.swift, TrainingLogView.swift)
- Lines changed: 35 (15 + 12 + 8)
- Total: 35 lines across 3 files
- Category: âœ… Small Change
- Justification: Adding incremental sync to existing HealthKit integration
```

---

## ğŸš« Prohibited Actions

### Never Do This

```markdown
âŒ Don't suggest whitespace-only changes
âŒ Don't create new APIs without explicit approval
âŒ Don't modify multiple files simultaneously without review
âŒ Don't assume missing dependencies or configurations
âŒ Don't invent APIs out of thin air
âŒ Don't rewrite working code "just to make it better"
âŒ Don't remove code just to silence errors
âŒ Don't comment out code instead of fixing it
âŒ Don't use placeholder/stub implementations in production code
```

### Especially for Epoch Project

```markdown
âŒ NEVER modify or delete HealthKit training records
âŒ NEVER hardcode API keys or sensitive data
âŒ NEVER bypass dependency injection
âŒ NEVER use force unwrap (!) without justification
âŒ NEVER block the main thread with heavy operations
âŒ NEVER skip error handling (no bare try!)
```

---

## âœ… Required Actions

### Always Do This

```markdown
âœ… Always cross-check information against provided context
âœ… Always show existing working code before proposing changes
âœ… Always rate solution complexity 1-10
âœ… Always justify complexity >3/10
âœ… Always find 2-3 existing similar patterns
âœ… Always comment deletions with reasons
âœ… Always ask for approval before large refactors
âœ… Always complete one file before moving to next
âœ… Always test that code compiles
âœ… Always preserve existing behavior
```

### Especially for Epoch Project

```markdown
âœ… Always mark ViewModel with @MainActor
âœ… Always use Protocol for Service dependencies
âœ… Always provide Mock implementations for testing
âœ… Always use LocalizedString for UI text
âœ… Always update file-structure.md after changes
âœ… Always record changes in changelog
âœ… Always run xcodebuild to verify compilation
```

---

## ğŸ§ª Testing Requirements

### Test-Driven Approach

```markdown
1. **Write Failing Test First**: Create test that exposes the issue/need
2. **Implement Minimal Fix**: Write just enough code to pass the test
3. **Refactor**: Clean up code while keeping tests green
4. **Verify**: Run full test suite to ensure no regressions
```

**Example:**
```swift
// Step 1: Write failing test
func testFetchIncrementalWorkouts() async throws {
    let service = HealthKitService()
    let since = Date().addingTimeInterval(-7 * 24 * 3600)
    let workouts = try await service.fetchIncrementalWorkouts(since: since)
    XCTAssertGreaterThan(workouts.count, 0)  // Fails - method doesn't exist
}

// Step 2: Implement minimal fix
actor HealthKitService {
    func fetchIncrementalWorkouts(since date: Date) async throws -> [HKWorkout] {
        // Minimal implementation to pass test
    }
}

// Step 3: Refactor (if needed)
// Step 4: Run all tests
```

### Test Coverage Requirements

```markdown
âœ… **Core business logic**: 70%+ coverage
âœ… **Critical paths**: 100% coverage
âœ… **New features**: Tests required before merge
âœ… **Bug fixes**: Regression test required
```

---

## ğŸ“Š Risk Assessment Template

**Use this template at the end of significant changes:**

```markdown
SELF-CHECK & RISK ASSESSMENT:

âœ… Evidence Verified:
- Found pattern in: `Epoch/Services/HealthKitService.swift:45-67`
- Complexity: 2/10 (minimal change)

âœ… Behavior Preserved:
- No changes to existing function signatures
- All existing tests should pass
- No removal of functionality

âœ… Change Size:
- Files affected: 2 (HealthKitService.swift, TrainingLogViewModel.swift)
- Lines changed: 28 total (18 + 10)
- Category: Small Change âœ…

âš ï¸ Potential Risks:
- iOS 18 compatibility: Added #available check âœ…
- Threading: Uses existing Actor pattern âœ…
- Performance: Minimal impact (same query mechanism) âœ…

âœ… Documentation:
- Updated file-structure.md âœ…
- Added to changelog âœ…
- No ADR needed (not architectural change) âœ…

ğŸ¯ Confidence Level: HIGH
- Based on existing proven pattern
- Minimal changes to critical paths
- Full test coverage planned
```

---

## ğŸ”„ Continuous Improvement

### Learn from Mistakes

```markdown
When an issue is discovered:
1. **Document the Issue**: Add to `docs/09-lessons-learned/`
2. **Update Rules**: Strengthen relevant quality gates
3. **Add Test**: Prevent regression
4. **Share Knowledge**: Update team documentation
```

### Quality Metrics

```markdown
Track these metrics over time:
- Number of regressions introduced
- Test coverage percentage
- Build failure rate
- Code review feedback frequency
```

---

## ğŸ”— Related Rules

- **00-project-overview.md**: Epoch project constraints and principles
- **01-workflow.md**: Build-Check-Fix cycle requirements
- **02-swift-ios-standards.md**: Coding standards and conventions
- **04-anti-overengineering.md**: Evidence-first and complexity control

---

**Remember**: Quality comes from discipline. Always verify information, preserve existing behavior, keep changes minimal, and ask when unsure. Better to ask a "stupid" question than to introduce a subtle bug.

---

**æœ€åæ›´æ–°**: 2025-11-03  
**ç‰ˆæœ¬**: 1.0  
**åŸºäº**: `025-preserve-behaviour.mdc` + `050-anti-hallucination.mdc`


