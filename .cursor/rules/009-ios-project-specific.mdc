---
description: "009: iOS 18/Swift 6 project-specific rules and WWDC 2024 features"
scopes: [chat, edit]
tags: [ios, swift6, wwdc2024, ios18, project-specific]
priority: 9
globs:
  - "**/*.swift"
  - "**/*.swiftui"
  - "**/*.xib"
  - "**/*.storyboard"
  - "**/*.xcassets"
  - "**/*.xcconfig"
alwaysApply: true
---

# iOS 18/Swift 6 Project-Specific Rules

You are working on an iOS 18/Swift 6 project with WWDC 2024 APIs. Follow these project-specific guidelines for optimal development.

## üéØ Platform Targets & Build Assumptions

### Development Environment
- **Xcode 16** toolchain
- **Swift 6** language mode (with strict concurrency checking)
- **App targets**: iOS 18 (iPhone) and watchOS 11 exclusively
- **No backwards-compatibility layers** are maintained

### iOS 18 / WWDC 2024 Features Available
- **Swift 6** strict concurrency and data race safety
- **@Observable** macro for modern state management
- **SwiftData** with enhanced relationships and concurrency
- **Enhanced SwiftUI** with new animations and controls
- **Swift Testing** framework (modern alternative to XCTest)
- **App Intents** enhancements for Siri and Shortcuts
- **Interactive Widgets** and Live Activities improvements

## üèóÔ∏è Architecture Rules

### Single ModelContainer
- **Use `ModelContainer.shared`** created in `RunParseApp`
- **No additional containers** are permitted
- **All SwiftData operations** must use the shared container

### SwiftDataManager Pattern
- **Implement as `@MainActor enum`** providing static helpers
- **Operate on `ModelContainer.shared.mainContext`**
- **Thread-safe access** to shared data context

### Model Relationships
- **`SwiftDataTrainingPlan.steps`** declared with `@Relationship(deleteRule: .cascade, inverse: \SwiftDataWorkoutStep.trainingPlan)`
- **Other relationships** retain existing inverse & cascade rules
- **Use SwiftData v2** relationship patterns

## üßµ Threading & Isolation

### Service Classes
All service classes must be annotated `@MainActor`:
- `WorkoutService`
- `TrainingPlanManager`
- `WeightDeltaService`
- `HRVSleepAggregator`
- `HRVDataFilter`
- `HealthKitDataFetcher`
- `AchievementService`

### SwiftData Operations
- **Any SwiftData write** must occur inside `await MainActor.run { ‚Ä¶ }`
- **Or on a `@MainActor` context**
- **Thread-safe data access** patterns

### Queries & Predicates
- **Use modern API**: `@Query(sort: [SortDescriptor(...)])` instead of key-path shorthand
- **Modern SwiftData** query patterns with predicates
- **Enhanced relationship** handling with proper inverse relationships

## üé® UI & Design System

### Color Helper
- **`Color(hex:)` extension** resides in `Utilities/Color+Hex.swift`
- **Data models must not import SwiftUI**
- **Separation of concerns** between data and UI

### SwiftUI Patterns
- **Use `@Observable`** for view models (not legacy `ObservableObject`)
- **Modern navigation** with `NavigationStack` and `NavigationSplitView`
- **Type-safe navigation** using `.navigationDestination(for:destination:)`

## üîß Build & Development

### Build Commands
**Preferred command (iPhone 16 Pro, iOS 18 Simulator):**
```bash
xcodebuild \
  -project RunParse.xcodeproj \
  -scheme RunParse \
  -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
  build && swift test
```

**Physical Device:**
```bash
xcodebuild \
  -project RunParse.xcodeproj \
  -scheme RunParse \
  -destination 'platform=iOS,id=<YOUR_DEVICE_UDID>' \
  build
```

**Outside macOS:** Run `swift build && swift test` to compile package and execute unit tests

### Development Workflow
1. **Edit** ‚ûú 2. **Run Build & Test recipe** ‚ûú 3. **Fix compile/test failures** ‚ûú 4. **Commit**
- **AI must complete the loop**; unfinished red builds are not allowed

## üö´ Behavior Preservation

### Change-Safety Rules
- **No regressions** ‚Äì all refactors must keep existing features, functions, and visual styles intact
- **Minimal patches** ‚Äì touch only necessary lines; avoid whitespace-only diffs
- **No stubs or placeholder code** ‚Äì implement real functionality only
- **Comment every deletion** with a brief rationale
- **Avoid superficial changes** (e.g., variable renames) unless they serve a clear purpose

### Design System Boundaries
- **All style tokens, modifiers, and generic UI patterns** live in `DesignSystem/`
- **Business-specific or data-driven views** (e.g., `WorkoutCardView`) stay in `Views/`
- **Import but never mutate or extend** `DesignSystem/`

## üéØ Feature & Style Addition

### Restriction Policy
- **Do not add new features, UI styles, or visual modifiers** unless explicitly requested in the prompt or ticket
- **Follow explicit requirements** only
- **No speculative enhancements**

### API Preference
- **When multiple approaches exist**, prefer APIs, patterns, and frameworks introduced at **WWDC 2024**
- **Unless backward-compatibility requirements** dictate otherwise
- **Modern Swift 6 patterns** over legacy approaches
- **Prefer @Observable** over ObservableObject
- **Use Swift Testing** for new tests when appropriate

## üìù Code Conventions

### Formatting
- **English comments**; any Chinese notes must be wrapped in `<!-- zh-note: ‚Ä¶ -->`
- **No multiple blank lines** inside functions; none at file start/end; no trailing whitespace
- **One-file focus** per edit session; avoid sweeping multi-file rewrites

### Documentation
- **Follow workspace "Always Applied Rules"** and user-specific directives
- **Don't invent APIs**; confirm ambiguity when requirements are unclear
- **Reference Apple documentation** for all API usage

## üîç Quality Assurance

### Testing Requirements
- **All changes must pass** build and test suite
- **No regressions** in existing functionality
- **Swift 6 compliance** for all new code (strict concurrency enabled)
- **iOS 18 compatibility** verification
- **Data race safety** verified by Swift 6 compiler

### Performance Standards
- **Main thread blocking** ‚â§ 16ms
- **SwiftData operations** optimized for iOS 18
- **Memory management** following Swift 6 patterns
- **Concurrency safety** with proper actor isolation
- **Sendable conformance** for types crossing concurrency boundaries

---

**Remember**: This project uses cutting-edge iOS 18 and Swift 6 features. Always prioritize modern patterns, data race safety, and the latest Apple APIs. Swift 6's strict concurrency checking helps prevent data races at compile time.