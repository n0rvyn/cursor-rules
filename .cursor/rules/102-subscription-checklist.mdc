---
description: "è®¢é˜…ä¸ Premium åŠŸèƒ½ - æ£€æŸ¥æ¸…å•"
scopes: [chat, edit]
tags: [subscription, premium, in-app-purchase, checklist]
priority: 102
globs: ["**/*Subscription*.swift", "**/*Premium*.swift"]
alwaysApply: false
---

# è®¢é˜…æ£€æŸ¥æ¸…å•

> **è§¦å‘æ¡ä»¶**: ç¼–è¾‘è®¢é˜…/Premium ç›¸å…³æ–‡ä»¶æ—¶è‡ªåŠ¨åŠ è½½  
> **è¯¦ç»†å‚è€ƒ**: `docs/03-decisions/ADR-011-subscription-implementation.md`

---

## âš ï¸ æ“ä½œå‰å¿…é¡»å®Œæˆ

### 1. ç¡®è®¤ Premium åŠŸèƒ½å®šä¹‰

- [ ] è¯»å– `docs/01-product/subscription-tiers.md`ï¼ˆäº§å“å®šä¹‰ï¼‰
- [ ] è¯»å– `docs/03-decisions/ADR-011-subscription-implementation.md`ï¼ˆæŠ€æœ¯å®ç°ï¼‰

### 2. Premium éªŒè¯æ£€æŸ¥

- [ ] æ‰€æœ‰ AI åŠŸèƒ½è°ƒç”¨å‰éªŒè¯ Premium çŠ¶æ€
- [ ] ä½¿ç”¨ Firebase Custom Claimsï¼š`user.customClaims['premium']`
- [ ] Premium çŠ¶æ€ç¼“å­˜ï¼š1 å°æ—¶

---

## ğŸ”´ æ ¸å¿ƒçº¦æŸ

### Premium åŠŸèƒ½é™åˆ¶è¡¨ â­â­â­â­â­

| åŠŸèƒ½ | å…è´¹ç”¨æˆ· | Pro ç”¨æˆ· |
|---|---|---|
| AI è®¡åˆ’ç”Ÿæˆ | 1æ¬¡/æœˆ | æ— é™ |
| AI å³æ—¶åé¦ˆ | 3æ¬¡/æœˆ | æ— é™ |
| å¯¹è¯å¼è°ƒæ•´ | âŒ ä¸æ”¯æŒ | æ— é™ |
| å†å²æ•°æ® | 90å¤© | æ— é™æœŸ |

### Premium éªŒè¯æµç¨‹

```swift
// âœ… æ‰€æœ‰ AI è°ƒç”¨å‰å¿…é¡»éªŒè¯
@MainActor
func generateTrainingPlan() async throws {
    // Step 1: éªŒè¯ Premium çŠ¶æ€
    guard let isPremium = user.customClaims['premium'] as? Bool,
          isPremium == true else {
        // Step 2: æ£€æŸ¥å…è´¹é¢åº¦
        let usageCount = try await checkUsageCount(for: .planGeneration)
        guard usageCount < 1 else {
            throw SubscriptionError.quotaExceeded
        }
    }
    
    // Step 3: æ‰§è¡Œ AI è°ƒç”¨
    let plan = try await aiService.generatePlan(...)
    
    // Step 4: æ›´æ–°ä½¿ç”¨æ¬¡æ•°ï¼ˆå¦‚æœæ˜¯å…è´¹ç”¨æˆ·ï¼‰
    if !(isPremium ?? false) {
        try await incrementUsageCount(for: .planGeneration)
    }
}
```

### Custom Claims ç®¡ç†

```swift
// Backend (Firebase Functions) è®¾ç½® Custom Claims
admin.auth().setCustomUserClaims(uid, { premium: true })

// iOS è¯»å– Custom Claims
let user = Auth.auth().currentUser
let isPremium = user?.customClaims?["premium"] as? Bool ?? false

// Premium çŠ¶æ€ç¼“å­˜ï¼ˆ1 å°æ—¶ï¼‰
struct PremiumStatusCache {
    static var cachedStatus: Bool?
    static var cacheTime: Date?
    
    static func getPremiumStatus() async throws -> Bool {
        if let cached = cachedStatus,
           let time = cacheTime,
           Date().timeIntervalSince(time) < 3600 {  // 1 hour
            return cached
        }
        
        // å¼ºåˆ¶åˆ·æ–° token
        try await Auth.auth().currentUser?.getIDTokenResult(forcingRefresh: true)
        let isPremium = Auth.auth().currentUser?.customClaims?["premium"] as? Bool ?? false
        
        cachedStatus = isPremium
        cacheTime = Date()
        return isPremium
    }
}
```

---

## ğŸ“‹ æ“ä½œæ­¥éª¤æ¨¡æ¿

### ä¿æŠ¤ AI åŠŸèƒ½

```swift
// Step 1: æ£€æŸ¥ Premium çŠ¶æ€
let isPremium = try await PremiumStatusCache.getPremiumStatus()

// Step 2: å…è´¹ç”¨æˆ·æ£€æŸ¥é¢åº¦
if !isPremium {
    let usage = try await subscriptionService.getUsageCount(for: feature)
    let limit = subscriptionService.getFreeLimit(for: feature)
    
    guard usage < limit else {
        // æ˜¾ç¤º Paywall
        throw SubscriptionError.quotaExceeded
    }
}

// Step 3: æ‰§è¡ŒåŠŸèƒ½
let result = try await executeFeature()

// Step 4: è®°å½•ä½¿ç”¨ï¼ˆå…è´¹ç”¨æˆ·ï¼‰
if !isPremium {
    try await subscriptionService.incrementUsage(for: feature)
}
```

### æ”¶æ®éªŒè¯ï¼ˆApp Store Server API v2ï¼‰

```swift
// MVP é˜¶æ®µç®€åŒ–ï¼ˆå®¢æˆ·ç«¯éªŒè¯ï¼‰
let result = try await StoreKit.verifyReceipt()

// V1.1 å®ç°ï¼ˆæœåŠ¡ç«¯éªŒè¯ï¼‰
let result = try await backendService.verifyReceipt(receiptData)
```

---

## ğŸ”— è¯¦ç»†å‚è€ƒ

| æ–‡æ¡£ | å†…å®¹ |
|------|------|
| `docs/03-decisions/ADR-011-subscription-implementation.md` | â­ å®Œæ•´è®¢é˜…ç­–ç•¥ï¼ˆå¿…è¯»ï¼‰ |
| `docs/01-product/subscription-tiers.md` | äº§å“å®šä¹‰ |

---

**æœ€åæ›´æ–°**: 2025-11-08  
**Token ä¼°ç®—**: ~1,000 tokens  
**åŠ è½½æ–¹å¼**: Auto-attachï¼ˆglobs åŒ¹é…æ—¶ï¼‰  
**ä¼˜å…ˆçº§**: 102

