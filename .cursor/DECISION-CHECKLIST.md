# Decision 检查清单（Epoch 定制版 - 轻量）

> **Purpose**: 快速判断决策复杂度，选择合适的决策流程  
> **触发场景**: 做架构决策、技术选型、方案选择时  
> **项目**: Epoch iOS App（Swift 6.2 + iOS 18-26）

---

## 🎯 Epoch 项目特定约束

### Epoch 架构级决策（必须创建 ADR）
```markdown
以下变更属于架构级，必须创建 ADR：
- [ ] SwiftData Model 新增/修改关系
- [ ] Firebase Schema 变更
- [ ] 认证/授权策略变更
- [ ] 数据同步策略变更（Last Write Wins / Merge）
- [ ] 引入新的第三方库
- [ ] 修改三大铁律相关设计
- [ ] 性能指标调整（<2s/<5s/<100ms）

ADR 存放位置：docs/03-decisions/ADR-XXX-{title}.md
```

### Epoch 技术约束（决策时必须考虑）
```swift
已有技术栈（不轻易变更）：
- Swift 6.2 + Swift 并发（actor/async/await）
- SwiftUI（不用 UIKit）
- SwiftData（不用 Core Data）
- Firebase Firestore（不用 Realtime Database）
- XCTest（不引入第三方测试框架）

核心约束（不可违反）：
1. HealthKit 只读（永不删除/修改记录）
2. UESCA 训练原则（质量训练≤2次/周）
3. 性能指标（启动<2s, AI<5s, SwiftData<100ms）
```

### Epoch 决策证据来源（优先级）
```markdown
1. ⭐⭐⭐ 项目 ADR（docs/03-decisions/）
   - 已有决策记录，优先参考
   
2. ⭐⭐⭐ 实际测试数据
   - Epoch 项目实测（启动时间、查询耗时）
   
3. ⭐⭐ Apple 官方文档
   - SwiftData / SwiftUI / HealthKit 官方指南
   
4. ⭐ UESCA 教材
   - 训练计划相关决策的权威来源
   
5. 🟡 社区最佳实践（需验证）
   - Stack Overflow / GitHub 社区方案
```

---

## 🎯 快速判断：使用哪个流程？

### 复杂决策 → 使用 003-structured-decision-workflow.mdc

满足以下**任一条件** → 使用完整的结构化决策流程：

- [ ] 涉及 **2+ 个不确定因素**
- [ ] 需要**对比多个方案**（有 A/B/C 选项）
- [ ] **架构级变更**（数据模型/认证/同步/第三方库/项目结构）
- [ ] **影响重大**（影响多个模块或核心功能）
- [ ] **不可逆**（难以回滚或成本高）

**使用方式**：
```markdown
在 Chat 中说："请使用结构化决策流程"
或引用：@003-structured-decision-workflow.mdc
```

---

### 简单决策 → 使用本检查清单（轻量版）

**不满足**上述条件 → 使用本检查清单：

- 单一明确的问题
- 方案简单清晰
- 影响范围小
- 可快速验证
- 可轻易回滚

---

## ✅ 轻量决策检查（6 步）

### Step 1: 问题定义

- [ ] **要解决什么问题？**（一句话）
  ```markdown
  ✅ 好的问题定义：
  - "TrainingLogView 滚动卡顿，需要优化查询"
  - "UserProfile 字段过多，需要拆分为 BasicInfo + DetailedInfo"
  - "HealthKit 同步逻辑重复，需要提取公共方法"
  
  ❌ 差的问题定义：
  - "代码有问题"（太模糊）
  - "需要改进"（没说具体什么）
  ```

- [ ] **为什么现在解决？**（有证据吗？）
  ```markdown
  ✅ 好的理由：
  - 用户反馈：滚动卡顿（有截屏/视频）
  - 性能数据：查询耗时 5 秒（超过 100ms 标准）
  - 代码复杂度：函数 500 行（超过 50 行标准）
  
  ❌ 差的理由：
  - "我觉得不太好"（主观）
  - "可能会有问题"（没有实际证据）
  ```

- [ ] **不解决会怎样？**（影响评估）
  ```markdown
  影响分类：
  - 🔴 Critical: 影响核心功能，必须解决
  - 🟡 Important: 影响用户体验，应该解决
  - 🟢 Nice to have: 改进点，可以延后
  ```

---

### Step 2: 方案对比（至少 2 个）

**必须列出 2-3 个方案**，并对比优缺点：

```markdown
#### 方案 A: [简短描述] ⭐ 推荐

**优点**：
- 优点 1
- 优点 2

**缺点**：
- 缺点 1
- 缺点 2

**实施成本**：X 小时

---

#### 方案 B: [简短描述]

**优点**：
- 优点 1

**缺点**：
- 缺点 1
- 缺点 2

**实施成本**：Y 小时

---

#### 推荐：方案 A

**理由**：
1. 优点 1 更符合当前需求
2. 实施成本更低
3. 风险可控
```

- [ ] **至少 2 个方案**
- [ ] **优缺点具体**（不是泛泛而谈）
- [ ] **有明确的推荐**（不是"都行"）

---

### Step 3: 证据支持

- [ ] **有 ADR 支持吗？**
  ```bash
  # 搜索相关 ADR
  grep -r "关键词" docs/03-decisions/
  ```

- [ ] **有类似案例吗？**
  ```markdown
  参考：
  - Week X 的类似实现
  - 其他模块的类似方案
  - 开源项目的最佳实践
  ```

- [ ] **有测试数据吗？**
  ```markdown
  ✅ 好：基于测试数据决策
  - 方案 A 测试：查询耗时 200ms
  - 方案 B 测试：查询耗时 50ms
  - 结论：选择方案 B
  
  🟡 可接受：基于理论分析
  - 方案 A 理论复杂度 O(n²)
  - 方案 B 理论复杂度 O(n log n)
  - 结论：方案 B 更优
  
  ❌ 不好：纯推测
  - "方案 A 应该更快"（没有依据）
  ```

- [ ] **还是纯推测？⚠️**
  ```markdown
  如果是纯推测 → 建议先验证：
  1. 创建简单的 Proof of Concept
  2. 测试关键指标
  3. 基于测试结果决策
  ```

---

### Step 4: 风险评估

- [ ] **最大风险是什么？**
  ```markdown
  常见风险：
  - 性能风险：可能更慢
  - 兼容性风险：可能不支持旧版本
  - 复杂度风险：可能难以维护
  - 时间风险：可能超出预期时间
  ```

- [ ] **如果失败怎么办？**（回滚方案）
  ```markdown
  ✅ 可接受的风险：有回滚方案
  - 失败场景：性能不如预期
  - 回滚方案：切回旧实现（保留代码）
  - 回滚成本：1 小时
  
  ⚠️ 高风险：难以回滚
  - 失败场景：数据迁移失败
  - 回滚方案：手动恢复数据（困难）
  - 回滚成本：8 小时
  - 建议：增加测试验证，降低风险
  ```

- [ ] **是否可逆？**
  ```markdown
  - ✅ 可逆：代码变更、配置修改
  - ⚠️ 部分可逆：数据迁移（有备份）
  - ❌ 不可逆：删除数据、重大架构变更
  ```

---

### Step 5: 是否需要 ADR？

满足以下**任一条件** → **必须创建 ADR**：

- [ ] **数据模型变更**（新增/修改 SwiftData Model 关系）
- [ ] **认证/授权变更**（修改 Auth 策略）
- [ ] **同步策略变更**（修改 Firebase ↔ SwiftData 同步）
- [ ] **引入新库**（新增第三方依赖）
- [ ] **项目结构变更**（修改文件组织）
- [ ] **部署方式变更**（修改 Backend 部署）

**不满足** → 记录到 Changelog 即可

**ADR 创建指南**：
```markdown
1. 使用模板：docs/03-decisions/_template.md
2. 文件命名：ADR-XXX-简短描述.md
3. 必须包含：背景 + 决策 + 后果 + 实施
4. 添加到索引：docs/03-decisions/README.md
```

---

### Step 6: 实施计划（简化版）

- [ ] **实施步骤**（3-5 步）
  ```markdown
  1. Step 1: [具体操作]（预计 X 小时）
  2. Step 2: [具体操作]（预计 Y 小时）
  3. Step 3: [具体操作]（预计 Z 小时）
  
  总计：X+Y+Z 小时
  ```

- [ ] **验收标准**（如何验证成功？）
  ```markdown
  - [ ] 编译通过（xcodebuild）
  - [ ] 测试通过（单元测试 + 手动测试）
  - [ ] 性能达标（如查询 <100ms）
  - [ ] 文档更新（changelog + ADR）
  ```

---

## 📋 快速自检清单

决策前必须完成：

- [ ] ✅ Step 1: 问题定义（一句话 + 理由 + 影响）
- [ ] ✅ Step 2: 方案对比（至少 2 个 + 优缺点 + 推荐）
- [ ] ✅ Step 3: 证据支持（ADR/案例/测试/理论）
- [ ] ✅ Step 4: 风险评估（最大风险 + 回滚方案 + 可逆性）
- [ ] ✅ Step 5: 是否需要 ADR？（架构级变更必须创建）
- [ ] ✅ Step 6: 实施计划（3-5 步 + 验收标准）

---

## 🚫 常见错误（必须避免）

### ❌ 1. 只有 1 个方案

**错误示例**：
```markdown
"我要用方案 A 实现，没有其他选择"
```

**为什么错误**：
- 没有对比，无法评估是否最优
- 可能遗漏更好的方案
- 缺少替代方案（风险高）

**正确做法**：
```markdown
至少提供 2 个方案：
- 方案 A：当前想法
- 方案 B：替代方案（即使不推荐，也要列出）

对比后推荐方案 A，并说明为什么不选 B
```

---

### ❌ 2. 纯推测决策

**错误示例**：
```markdown
"方案 A 应该更快，我觉得性能会更好"
```

**为什么错误**：
- 没有证据支持
- 实施后可能发现不如预期
- 难以说服他人

**正确做法**：
```markdown
1. 先做简单测试（Proof of Concept）
2. 测量关键指标（性能/内存/复杂度）
3. 基于测试结果决策

或至少提供理论依据：
- 时间复杂度分析
- 官方文档推荐
- 社区最佳实践
```

---

### ❌ 3. 没有风险评估

**错误示例**：
```markdown
"方案 A 很好，直接实施"
```

**为什么错误**：
- 没有考虑失败情况
- 没有回滚方案
- 风险意识不足

**正确做法**：
```markdown
1. 列出可能的风险（至少 1-2 个）
2. 评估风险影响（高/中/低）
3. 准备缓解措施或回滚方案
```

---

### ❌ 4. 架构变更不创建 ADR

**错误示例**：
```markdown
"修改了数据模型关系，只记录到 changelog"
```

**为什么错误**：
- 架构决策应该有详细文档
- Changelog 太简短，无法追溯背景
- 未来维护困难（不知道为什么这样设计）

**正确做法**：
```markdown
架构级变更必须创建 ADR：
1. 创建 ADR 文档（背景 + 决策 + 后果）
2. 记录到 changelog（引用 ADR）
3. 更新相关实现文档
```

---

## 📊 决策复杂度参考

### 简单决策（本检查清单）

**特征**：
- 单一问题
- 2 个明确方案
- 影响 1-2 个文件
- 可快速验证（<1 小时）
- 可轻易回滚

**示例**：
- 优化某个查询（单个方法）
- 提取重复代码为公共方法
- 修改 UI 布局（不涉及数据）
- 调整配置参数

**决策时间**：10-30 分钟

---

### 复杂决策（结构化流程）

**特征**：
- 多个不确定因素（2+）
- 3+ 个方案需要对比
- 影响多个模块
- 需要长时间验证（>2 小时）
- 难以回滚或成本高

**示例**：
- 选择数据同步策略（实时/轮询/推送）
- 设计认证架构（JWT/Session/OAuth）
- 重构核心模块（影响 10+ 文件）
- 引入新技术栈（如 GraphQL）

**决策时间**：1-4 小时

**使用工具**：
- 003-structured-decision-workflow.mdc（标准流程）
- 208-decision-support-detailed.mdc（深入分析）

---

## 📝 决策记录模板

完成决策后，记录到 Changelog：

```markdown
文件：docs/07-changelog/2025-11.md

## 2025-11-08 16:00 - 决策：优化训练日志查询

### 🎯 问题
TrainingLogView 滚动卡顿，查询耗时 5 秒（超过 100ms 标准）

### 💡 方案对比
| 方案 | 优点 | 缺点 | 实施成本 | 推荐度 |
|------|-----|-----|---------|--------|
| A: 增加索引 | 快速、简单 | 内存占用+10MB | 1h | ⭐⭐⭐⭐⭐ |
| B: 分页加载 | 内存友好 | 实现复杂 | 4h | ⭐⭐⭐ |

### ✅ 决策
采用方案 A（增加索引）

**理由**：
- 实施成本低（1h vs 4h）
- 性能提升明显（测试：5s → 50ms）
- 内存占用增加可接受（10MB）

**风险**：
- 内存占用增加 10MB（可接受）
- 回滚方案：删除索引（5 分钟）

### 📊 实施结果
- 查询耗时：5s → 50ms ✅
- 内存占用：+10MB ✅
- 用户反馈：滚动流畅 ✅

### 📄 相关文档
- 不需要 ADR（非架构级变更）
- 代码变更：TrainingLogRepository.swift
```

---

## 📚 参考资料

- **完整决策流程**: @003-structured-decision-workflow.mdc
- **深入决策支持**: @208-decision-support-detailed.mdc
- **ADR 模板**: docs/03-decisions/_template.md
- **辨证思考铁律**: @000-critical-rules.mdc（AI 工作原则）

---

**版本**: v1.0  
**创建时间**: 2025-11-08  
**维护者**: Epoch Team

